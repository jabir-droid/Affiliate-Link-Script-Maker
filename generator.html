<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Detail Produk & Konfigurasi</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<!-- jsPDF for Export PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
:root{
  --bg:#ffffff; --panel:#ffffff; --muted:#475569; --txt:#0f172a; --border:#e5e9f5;
  --blue:#12b3ff; --purple:#7b5cff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--txt);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(60% 60% at 20% -10%, rgba(231,241,255,.75) 0%, transparent 65%),
    radial-gradient(60% 60% at 80% -10%, rgba(239,230,255,.75) 0%, transparent 65%),
    linear-gradient(180deg,#f7fbff 0%, #f2f6ff 40%, #f8f9ff 100%);
}
.wrap{max-width:1120px;margin:0 auto;padding:22px 16px 120px}
.title{font-weight:900;letter-spacing:-.02em;margin:0;font-size:clamp(28px,5.3vw,46px);
  background:linear-gradient(90deg,#3b82f6,#8b5cf6);-webkit-background-clip:text;background-clip:text;color:transparent}
.muted{color:var(--muted)}
.toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:4px 0 10px}
.btn-ghost, .btn-chip {
  padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;color:#0f172a;font-weight:700;cursor:pointer
}
.btn-chip{display:inline-flex;align-items:center;gap:8px}
.btn-gradient{
  padding:14px 16px;border-radius:14px;border:none;color:#fff;font-weight:800;cursor:pointer;width:100%;
  background:linear-gradient(90deg,var(--blue),var(--purple));box-shadow:0 16px 42px rgba(123,92,255,.30);
}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 18px 44px rgba(15,23,42,.08)}
.headline{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border);background:#ffffffc0;border-top-left-radius:18px;border-top-right-radius:18px}
.inp{width:100%;padding:14px 16px;border:1px solid var(--border);border-radius:14px;background:#f7faff;outline:none;transition:border .15s ease,box-shadow .15s ease}
.inp:focus{border-color:#7b5cff;box-shadow:0 0 0 4px rgba(124,92,255,.18)}
.seg input{display:none}
.seg label{border:1px solid var(--border);background:#f7faff;padding:14px 16px;border-radius:16px;cursor:pointer;text-align:center;font-weight:700;display:block;transition:box-shadow .15s ease,border .15s ease, transform .05s}
.seg input:checked + label{background:linear-gradient(90deg, rgba(18,179,255,.16), rgba(124,92,255,.16));border-color:#7b5cff;box-shadow:0 0 0 3px rgba(124,92,255,.18)}
.seg label:active{transform:translateY(1px)}
.grid2{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:860px){ .grid2{grid-template-columns:1fr 1fr} }
.grid3{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:860px){ .grid3{grid-template-columns:repeat(3,1fr)} }

.actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}
.card{padding:16px 16px 14px}
.res-title{font-weight:800;color:#3b82f6;margin:0 0 10px;font-size:18px}
.tools{display:flex;gap:8px;flex-wrap:wrap}
.tool{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700}
footer{text-align:center;color:#64748b;margin-top:28px}
.sticky{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(255,255,255,0),#f6f9ff .4,#f6f9ff);padding:12px 16px;border-top:1px solid var(--border)}
</style>
</head>
<body>
  <main class="wrap">
    <div class="toolbar">
      <button onclick="history.back()" class="btn-ghost">‚Üê Kembali</button>
      <div style="display:flex;gap:10px">
        <button id="btnGuide" class="btn-ghost">‚ÑπÔ∏è Panduan</button>
        <div class="btn-chip">Kuota: <b id="quotaNow">‚Äî</b> / 1000 <button id="btnRefreshQuota" class="btn-ghost">‚Üª Refresh</button></div>
      </div>
    </div>
    <h1 class="title">Detail Produk & Konfigurasi</h1>
    <p class="muted" style="margin:.25rem 0 16px">Buat skrip promosi afiliasi Anda</p>

    <!-- Panduan -->
    <section id="guidePanel" class="panel" style="display:none;margin-bottom:12px">
      <div class="headline"><strong>Panduan Penggunaan</strong></div>
      <div class="card">
        <ol style="line-height:1.8;margin:0">
          <li>Masukkan <b>link produk</b> & info dasar.</li>
          <li>Tambahkan <b>kelebihan/keunggulan</b> (minimal <b>2</b>).</li>
          <li>Pilih <b>gaya bahasa</b> yang sesuai.</li>
          <li>Tentukan <b>panjang tulisan</b>.</li>
          <li>Klik <b>Mulai Hasilkan</b>.</li>
          <li><b>Salin/Edit/Unduh</b> hasil atau export PDF.</li>
        </ol>
      </div>
    </section>

    <!-- Form -->
    <section class="panel">
      <div class="headline">üìù <strong>Form Input Produk</strong></div>
      <div class="card">
        <label class="muted">Link Produk *</label>
        <input id="productUrl" type="url" placeholder="https://tokopedia.com/..." class="inp">

        <label class="muted" style="margin-top:12px">Nama / Jenis Produk *</label>
        <input id="productTopic" type="text" placeholder="Contoh: Smartwatch X Pro" class="inp">

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <label class="muted">Kelebihan / Keunggulan Produk *</label>
          <button id="addDescTop" class="btn-ghost">+ Tambah</button>
        </div>
        <input id="descInput" class="inp" placeholder="Contoh: Tahan Air IP68, Baterai 7 Hari, dll (Enter untuk tambah)">
        <div id="chips" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px"></div>

        <label class="muted" style="margin-top:12px">Jumlah Variasi Konten</label>
        <input id="count" type="number" min="1" max="10" value="3" class="inp">
        <div class="muted" style="font-size:12px;margin-top:4px">Antara 1‚Äì10 variasi</div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label class="muted">Gaya Bahasa</label>
            <div class="seg grid2">
              <input type="radio" name="style" id="sty1" value="Santai & Ramah" checked><label for="sty1">Santai & Ramah</label>
              <input type="radio" name="style" id="sty2" value="Formal & Informatif"><label for="sty2">Formal & Informatif</label>
              <input type="radio" name="style" id="sty3" value="Promosi Soft Selling"><label for="sty3">Promosi Soft Selling</label>
              <input type="radio" name="style" id="sty4" value="Penulisan Naskah Iklan (AIDA/PAS)"><label for="sty4">Penulisan Naskah Iklan (AIDA/PAS)</label>
            </div>
          </div>
          <div>
            <label class="muted">Panjang Tulisan</label>
            <div class="seg grid3">
              <input type="radio" name="length" id="len1" value="Pendek (1 paragraf)"><label for="len1">Pendek (1 paragraf)</label>
              <input type="radio" name="length" id="len2" value="Sedang (2-3 paragraf)" checked><label for="len2">Sedang (2-3 paragraf)</label>
              <input type="radio" name="length" id="len3" value="Panjang (artikel mini)"><label for="len3">Panjang (artikel mini)</label>
            </div>
          </div>
        </div>

        <div id="err" style="color:#e11d48;margin-top:8px;min-height:18px"></div>
        <button id="btnGenerate" class="btn-gradient">‚ú® Mulai Hasilkan</button>
      </div>
    </section>

    <section class="actions" style="margin-top:16px;display:none" id="batchActions">
      <button class="btn-ghost" onclick="downloadAllTxt()">‚¨áÔ∏è Unduh Semua (.zip)</button>
      <button class="btn-ghost" onclick="exportAllPdf()">üßæ Export PDF Semua</button>
    </section>

    <section id="results" style="margin-top:14px;display:grid;gap:12px"></section>

    <footer>¬© 2025 ‚Äì Dilarang Menduplikasi dan Menyebarluaskan Tanpa Izin Pemilik.</footer>
  </main>

  <!-- Sticky CTA for mobile -->
  <div class="sticky" id="stickyCta">
    <button id="btnGenerateMobile" class="btn-gradient">‚ú® Mulai Hasilkan</button>
  </div>

<script>
const guide = document.getElementById('guidePanel');
document.getElementById('btnGuide').onclick = ()=> guide.style.display = guide.style.display==='none'?'':'none';

async function loadQuota(){
  try{ const r=await fetch('/api/quota'); const j=await r.json(); document.getElementById('quotaNow').textContent=j.remaining ?? '‚Äî' }
  catch{ document.getElementById('quotaNow').textContent='‚Äî' }
}
document.getElementById('btnRefreshQuota').onclick = loadQuota; loadQuota();

/* chips */
const chips = []; const chipsEl = document.getElementById('chips'); const inputEl=document.getElementById('descInput');
function renderChips(){
  chipsEl.innerHTML='';
  chips.forEach((t,i)=>{
    const s=document.createElement('span');
    s.className='btn-ghost'; s.style.padding='8px 10px';
    s.innerHTML=`${escapeHtml(t)} <button data-i="${i}" class="btn-ghost" style="padding:4px 8px">‚úï</button>`;
    s.querySelector('button').onclick=e=>{ chips.splice(+e.target.dataset.i,1); renderChips() };
    chipsEl.appendChild(s);
  });
}
function addChip(){ const v=inputEl.value.trim(); if(!v) return; chips.push(v); inputEl.value=''; renderChips();}
inputEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addChip(); }});
document.getElementById('addDescTop').onclick=addChip;

/* generate */
const waitTxt = '‚è≥ <b>Tunggu sebentar‚Ä¶</b> <span class="muted">AI sedang meracik kata-kata untuk Anda‚Ä¶</span>';
function setBusy(btn, busy){
  if(busy){ btn.dataset.old = btn.innerHTML; btn.innerHTML = waitTxt; btn.disabled = true }
  else { btn.innerHTML = btn.dataset.old || '‚ú® Mulai Hasilkan'; btn.disabled = false }
}
function getVal(name, def){ const el=document.querySelector(`input[name="${name}"]:checked`); return el?el.value:def }

document.getElementById('btnGenerate').onclick = ()=> doGen(document.getElementById('btnGenerate'));
document.getElementById('btnGenerateMobile').onclick = ()=> doGen(document.getElementById('btnGenerateMobile'));

async function doGen(btn){
  const err = document.getElementById('err'); err.textContent='';
  const url = document.getElementById('productUrl').value.trim();
  const topic = document.getElementById('productTopic').value.trim();
  const style = getVal('style','Santai & Ramah');
  const length = getVal('length','Sedang (2-3 paragraf)');
  const count = Math.max(1, Math.min(10, Number(document.getElementById('count').value||3)));
  if(!url){ err.textContent='Link Produk wajib diisi.'; return }
  if(!topic){ err.textContent='Nama / Jenis Produk wajib diisi.'; return }
  if(chips.length < 2){ err.textContent='Minimal 2 kelebihan / keunggulan.'; return }

  const body = { linkProduk:url, topik:topic, deskripsi:[...chips], gaya:style, panjang:length, jumlah:count };
  setBusy(btn,true);
  try{
    const r = await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
    const j = await r.json();
    if(!r.ok || !j.ok) throw new Error(j.message || 'Gagal generate.');
    renderResults(j.scripts||[]);
    document.getElementById('batchActions').style.display = j.scripts?.length ? '' : 'none';
    window.scrollTo({ top: document.getElementById('results').offsetTop - 40, behavior:'smooth' });
  }catch(e){ err.textContent=e.message||'Gagal generate.' }
  finally{ setBusy(btn,false) }
}

/* results */
const EMO = ['‚ú®','üöÄ','üí°','üì£','üî•','üåü','üß≤'];
function pickEmoji(i){ return EMO[i % EMO.length] }
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

let lastScripts = [];
function renderResults(arr){
  lastScripts = arr.map((s,i)=> ({ title: s.title || 'Variasi', content: s.content || '', i }) );
  const box = document.getElementById('results'); box.innerHTML='';
  lastScripts.forEach((s,idx)=>{
    const art=document.createElement('article'); art.className='panel';
    const emoji = pickEmoji(idx);
    art.innerHTML=`
      <div class="card">
        <h3 class="res-title">${emoji} ${escapeHtml(s.title)}</h3>
        <div data-view class="muted" style="white-space:pre-wrap;color:#0f172a">${escapeHtml(s.content)}</div>
        <textarea data-edit style="display:none;width:100%;min-height:160px" class="inp"></textarea>
        <div class="tools" style="margin-top:10px">
          <button class="tool" data-edit-btn>‚úèÔ∏è Edit</button>
          <button class="tool" data-copy>üìã Salin</button>
          <button class="tool" data-txt>‚¨áÔ∏è Unduh .txt</button>
          <button class="tool" data-pdf>üßæ Export PDF</button>
        </div>
      </div>`;
    const view=art.querySelector('[data-view]');
    const ta=art.querySelector('[data-edit]');
    const btnEdit=art.querySelector('[data-edit-btn]');
    ta.value = s.content;

    btnEdit.onclick=()=>{
      const showEdit = ta.style.display==='none';
      ta.style.display = showEdit?'':'none';
      view.style.display = showEdit?'none':'';
      btnEdit.textContent = showEdit?'üíæ Simpan':'‚úèÔ∏è Edit';
      if(!showEdit){ // save
        s.content = ta.value;
        view.textContent = s.content;
      }
    }
    art.querySelector('[data-copy]').onclick=()=>{ navigator.clipboard.writeText(s.content).then(()=>{ alert('Tersalin!') }) }
    art.querySelector('[data-txt]').onclick=()=>{ const blob=new Blob([s.content],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`script-${idx+1}.txt`; a.click(); URL.revokeObjectURL(a.href) }
    art.querySelector('[data-pdf]').onclick=()=> exportPdfSingle(s, idx+1);
    box.appendChild(art);
  });
}
function exportPdfSingle(s, n){
  const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit:'pt', format:'a4' });
  doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.text(`${s.title}`, 40, 50);
  doc.setFont('helvetica','normal'); doc.setFontSize(12);
  const text = doc.splitTextToSize(s.content, 515);
  doc.text(text, 40, 80);
  doc.save(`script-${n}.pdf`);
}
function exportAllPdf(){
  if(!lastScripts.length) return;
  const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit:'pt', format:'a4' });
  lastScripts.forEach((s,i)=>{
    if(i>0) doc.addPage();
    doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.text(s.title, 40, 50);
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    const text = doc.splitTextToSize(s.content, 515);
    doc.text(text, 40, 80);
  });
  doc.save('semua-script.pdf');
}
async function downloadAllTxt(){
  // sederhana: generate satu file gabungan
  const all = lastScripts.map((s,i)=>`# ${s.title}\n\n${s.content}\n\n---\n`).join('\n');
  const blob=new Blob([all],{type:'text/plain'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='semua-script.txt'; a.click(); URL.revokeObjectURL(a.href);
}
</script>
</body>
</html>
