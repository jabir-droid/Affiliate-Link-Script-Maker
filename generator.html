<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Generator • Affiliate Link Script Maker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --fg:#e6e9f2; --muted:#c5cee0;
      --panel:rgba(8,13,23,.72); --panel2:rgba(8,13,23,.68);
      --border:rgba(148,163,184,.18);
      --chipBg:linear-gradient(180deg,rgba(99,102,241,.16),rgba(37,99,235,.06));
      --g1:#60a5fa; --g2:#a78bfa;
      --indigo:#4f46e5; --slate:#94a3b8;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--fg);
      background:
        radial-gradient(1100px 520px at 0% -10%, rgba(96,165,250,.16), transparent 60%),
        radial-gradient(1100px 520px at 100% 0%, rgba(167,139,250,.14), transparent 60%),
        url("/bg/landing-city.jpg") center/cover fixed no-repeat;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:28px 20px 80px}
    .title-grad{background:linear-gradient(90deg,var(--g1),var(--g2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .glass{background:var(--panel);border:1px solid var(--border);border-radius:24px;box-shadow:0 12px 40px rgba(0,0,0,.35);backdrop-filter:blur(10px)}
    .glass2{background:var(--panel2);border:1px solid var(--border);border-radius:20px;backdrop-filter:blur(8px)}
    .btn{border:0;border-radius:12px;color:#fff;background:#4f46e5;padding:12px 16px;cursor:pointer}
    .btn:hover{background:#4338ca}
    .btn-soft{background:#334155;color:#eaeefb}
    .chip{background:var(--chipBg);border:1px solid rgba(99,102,241,.35);border-radius:999px;padding:6px 12px;color:#cfe0ff}
    .inp{width:100%;border-radius:14px;background:rgba(15,23,42,.6);border:1px solid #475569;color:#e6e9f2;padding:12px 14px;outline:none}
    .inp:focus{border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.25)}
    .seg{display:grid;gap:10px}
    .seg > label{display:block;border:1px solid #475569;border-radius:14px;background:rgba(15,23,42,.6);padding:12px 14px;cursor:pointer}
    .seg input{display:none}
    .seg input:checked + label{border-color:#7c5cff;background:linear-gradient(90deg,rgba(18,179,255,.14),rgba(124,92,255,.14))}
    .muted{color:#c5cee0}
    .results .card{background:var(--panel2);border:1px solid var(--border);border-radius:18px;padding:16px}
    .copy{background:#334155;color:#eaeefb;border-radius:10px;padding:8px 12px;border:0;cursor:pointer}
    .copy:hover{background:#475569}
  </style>
</head>
<body>
  <main class="wrap">
    <!-- Header -->
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
      <button onclick="history.back()" class="btn-soft">← Kembali</button>
      <div>
        <h2 class="title-grad" style="margin:0;font-size:clamp(28px,5vw,44px);font-weight:800">Generator Skrip Afiliasi</h2>
        <p class="muted" style="margin:6px 0 0">Tempel link produk, isi data singkat di bawah ini, lalu klik “Buat Skrip”.</p>
      </div>
      <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
        <button id="btnGuide" class="btn-soft">ℹ Panduan</button>
        <span class="chip">Sisa kuota hari ini: <b id="quotaLabel">—</b></span>
        <button id="btnRefreshQuota" class="btn-soft">Refresh</button>
      </div>
    </div>

    <!-- Guide -->
    <section id="guide" class="glass2" style="display:none;padding:14px 16px;margin-bottom:12px">
      <strong class="title-grad" style="font-size:18px">Panduan Penggunaan</strong>
      <ol style="margin:10px 0 0;line-height:1.8">
        <li>Masukkan <b>link produk</b> & info dasar.</li>
        <li>Tambahkan <b>kelebihan/keunggulan</b> (≥1).</li>
        <li>Pilih <b>gaya bahasa</b> yang sesuai.</li>
        <li>Tentukan <b>panjang tulisan</b>.</li>
        <li>Klik <b>Mulai Hasilkan</b>.</li>
        <li><b>Salin hasil</b> atau download.</li>
      </ol>
    </section>

    <!-- FORM -->
    <section class="glass" style="padding:20px">
      <div class="grid" style="display:grid;gap:16px">
        <div>
          <label class="muted" style="display:block;margin-bottom:6px">Link Produk <span style="color:#22d3ee">*</span></label>
          <input id="productUrl" type="url" class="inp" placeholder="Contoh: tautan TikTok / Tokopedia / Shopee"/>
        </div>

        <div>
          <label class="muted" style="display:block;margin-bottom:6px">Nama / Jenis Produk <span style="color:#22d3ee">*</span></label>
          <input id="productTopic" type="text" class="inp" placeholder="Contoh: tecno spark, sandal kulit, kaos distro pria, dll"/>
        </div>

        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <label class="muted">Kelebihan / Keunggulan <span style="color:#22d3ee">*</span></label>
            <div style="display:flex;gap:8px">
              <button id="btnAddDesc" type="button" class="btn">+ Tambah</button>
              <button id="btnRemoveDesc" type="button" class="btn-soft">– Hapus</button>
            </div>
          </div>
          <div id="descWrap" style="display:grid;grid-template-columns:1fr;gap:10px}
          ">
            <input class="descItem inp" placeholder="Contoh: nyaman dipakai seharian"/>
            <input class="descItem inp" placeholder="Contoh: bahan awet & kuat"/>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr;gap:12px">
          <div>
            <label class="muted" style="display:block;margin-bottom:6px">Jumlah variasi</label>
            <input id="count" type="number" min="1" max="5" value="3" class="inp"/>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <label class="muted" style="display:block;margin-bottom:6px">Gaya Bahasa</label>
              <div class="seg">
                <input id="st1" type="radio" name="style" value="Gen Z" checked>
                <label for="st1">Gen Z</label>
                <input id="st2" type="radio" name="style" value="Persuasif & Menjual">
                <label for="st2">Persuasif & Menjual</label>
                <input id="st3" type="radio" name="style" value="Santai & Kasual">
                <label for="st3">Santai & Kasual</label>
                <input id="st4" type="radio" name="style" value="Informatif & Edukatif">
                <label for="st4">Informatif & Edukatif</label>
              </div>
            </div>
            <div>
              <label class="muted" style="display:block;margin-bottom:6px">Panjang</label>
              <div class="seg">
                <input id="ln1" type="radio" name="length" value="Sedang" checked>
                <label for="ln1">Sedang</label>
                <input id="ln2" type="radio" name="length" value="Pendek">
                <label for="ln2">Pendek</label>
                <input id="ln3" type="radio" name="length" value="Panjang">
                <label for="ln3">Panjang</label>
              </div>
            </div>
          </div>
        </div>

        <div>
          <button id="btnGenerate" class="btn" style="display:inline-flex;align-items:center;gap:8px;background:linear-gradient(90deg,#23b1ff,#6a5cff)">✨ Mulai Hasilkan</button>
          <span id="err" style="margin-left:10px;color:#fda4af;font-weight:700"></span>
        </div>
      </div>
    </section>

    <!-- HASIL -->
    <section id="results" class="results" style="margin-top:16px;display:grid;gap:12px"></section>

    <footer style="margin-top:18px;text-align:center;color:#c5cee0;font-size:14px">
      © 2025 — Dibuat untuk Mempermudah promosi afiliasi.
    </footer>
  </main>

  <script>
    // toggle panduan
    btnGuide.onclick=()=>{ guide.style.display = guide.style.display==='none' ? 'block' : 'none' }

    // kuota
    async function loadQuota(){
      const q = document.getElementById('quotaLabel');
      q.textContent = '…';
      try{
        const r = await fetch('/api/quota');
        const j = await r.json();
        q.textContent = (j && typeof j.remaining === 'number') ? j.remaining : '—';
      }catch{ q.textContent = '—'; }
    }
    btnRefreshQuota.onclick = loadQuota; loadQuota();

    // desc dinamis
    const wrap = document.getElementById('descWrap');
    btnAddDesc.onclick = () => { const el=document.createElement('input'); el.className='descItem inp'; el.placeholder='Kelebihan lain…'; wrap.appendChild(el) }
    btnRemoveDesc.onclick = () => { const items=wrap.querySelectorAll('.descItem'); if(items.length>2) items[items.length-1].remove() }

    // util
    const escapeHtml = s => String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // generate
    btnGenerate.onclick = generate;
    async function generate(){
      const err = document.getElementById('err'); err.textContent='';
      const url = document.getElementById('productUrl').value.trim();
      const topic = document.getElementById('productTopic').value.trim();
      const style = (document.querySelector('input[name="style"]:checked')||{}).value || 'Gen Z';
      const length = (document.querySelector('input[name="length"]:checked')||{}).value || 'Sedang';
      const count = Math.max(1, Math.min(5, Number(document.getElementById('count').value||3)));
      const descriptions = Array.from(document.querySelectorAll('.descItem')).map(i=>i.value.trim()).filter(Boolean);

      if(!url)   return err.textContent='Link Produk wajib diisi.';
      if(!topic) return err.textContent='Nama / Jenis Produk wajib diisi.';
      if(descriptions.length<2) return err.textContent='Minimal 2 kelebihan / keunggulan.';

      const btn = btnGenerate, original = btn.innerHTML;
      btn.disabled = true; btn.innerHTML = 'AI sedang meracik kata-kata…';

      try{
        const r = await fetch('/api/generate',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            linkProduk:url, topik:topic, deskripsi:descriptions, gaya:style, panjang:length, jumlah:count,
            // back-compat
            link:url, topic, descriptions, style, length, generateCount:count, count
          })
        });
        const raw = await r.text(); let j=null; try{ j = raw ? JSON.parse(raw) : null }catch{}
        if(!r.ok || !j || !j.ok){ const msg = j?.message || raw || 'Gagal generate'; throw new Error(msg) }
        renderResults(j.scripts||[]); loadQuota();
      }catch(e){ err.textContent = e.message }
      finally{ btn.disabled=false; btn.innerHTML = original }
    }

    function renderResults(scripts){
      const box = document.getElementById('results');
      box.innerHTML = '';
      if(!scripts.length){ box.innerHTML = '<div class="card muted">Tidak ada hasil.</div>'; return; }
      scripts.forEach((s,i)=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3 style="margin:0 0 6px;color:#93c5fd">Variasi ${i+1} • ${escapeHtml(s.title||'Hasil')}</h3>
          <div class="content" style="white-space:pre-wrap;line-height:1.7">${escapeHtml(s.content||'')}</div>
          <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
            <button class="copy" data-copy>Salin</button>
          </div>
        `;
        card.querySelector('[data-copy]').onclick = () => {
          const text = card.querySelector('.content').textContent || '';
          navigator.clipboard.writeText(text).then(()=>{
            const b=card.querySelector('[data-copy]'); b.textContent='Tersalin!'; setTimeout(()=>b.textContent='Salin',1200);
          })
        };
        box.appendChild(card);
      });
    }
  </script>
</body>
</html>
