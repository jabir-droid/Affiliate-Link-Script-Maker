<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Detail Produk & Konfigurasi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#ffffff; --bg2:#f5f9ff; --panel:#ffffff; --border:#e3e8f4;
      --txt:#0f172a; --muted:#475569; --blue:#12b3ff; --purple:#7b5cff;
    }
    html,body{height:100%}
    body{
      margin:0;color:var(--txt);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1000px 420px at 10% -10%, rgba(231,241,255,.85) 0%, transparent 60%),
        radial-gradient(1000px 450px at 95% 0%, rgba(239,230,255,.85) 0%, transparent 60%),
        url("/bg/generator-code.jpg") center/cover no-repeat fixed;
      position:relative; isolation:isolate;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
      background-image: radial-gradient(circle at 1px 1px, rgba(93,109,169,.12) 1px, transparent 1.2px);
      background-size: 22px 22px; opacity:.45; mix-blend-mode:multiply;
    }
    .g-title{background:linear-gradient(90deg,#3b82f6,#8b5cf6);-webkit-background-clip:text;background-clip:text;color:transparent}
    .glass{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 18px 40px rgba(15,23,42,.08)}
    .pill{background:#f3f6ff;border:1px solid var(--border);border-radius:12px}
    .inp{width:100%;border:1px solid var(--border);background:#f9fbff;padding:14px 16px;border-radius:14px;color:var(--txt);outline:none}
    .inp:focus{border-color:#4ea8ff;box-shadow:0 0 0 3px rgba(78,168,255,.18)}
    .seg input{display:none}
    .seg label{border:1px solid var(--border);background:#f9fbff;padding:14px 16px;border-radius:16px;cursor:pointer;text-align:center;font-weight:600}
    .seg input:checked + label{background:linear-gradient(90deg, rgba(18,179,255,.18), rgba(124,92,255,.18));border-color:#7c5cff;box-shadow:0 0 18px rgba(124,92,255,.20)}
    .cta{background:linear-gradient(90deg,var(--blue),var(--purple));box-shadow:0 12px 36px rgba(123,92,255,.28);color:#fff}
    .title-size{font-size:clamp(26px, 4.5vw, 44px); line-height:1.08}
    .section-pad{padding:clamp(16px, 3vw, 28px)}

    /* --- Efek sentuhan universal --- */
    .touch-card { transition: transform .18s ease, box-shadow .18s ease, background-color .18s ease; will-change: transform, box-shadow; }
    .touch-card:hover { transform: translateY(-3px); box-shadow: 0 16px 38px rgba(15,23,42,.16); }
    .touch-card:active { transform: translateY(-1px) scale(.997); }
    .touch-input, .touch-select, .touch-textarea { transition: box-shadow .18s ease, border-color .18s ease, background-color .18s ease; }
    .touch-input:focus, .touch-select:focus, .touch-textarea:focus { box-shadow: 0 0 0 4px rgba(79, 70, 229, .18); outline: none; }
    .touch-btn { transition: transform .14s ease, box-shadow .14s ease, opacity .14s ease; }
    .touch-btn:hover { box-shadow: 0 14px 36px rgba(123,92,255,.28); }
    .touch-btn:active { transform: translateY(1px) scale(.99); }

    /* Mobile (‚â§640) */
    @media (max-width:640px){
      .seg-style,.seg-length{display:grid;grid-template-columns:1fr;gap:12px}
      .sticky-cta{position:fixed;left:0;right:0;bottom:0;padding:12px 16px calc(env(safe-area-inset-bottom) + 14px);background:linear-gradient(180deg,rgba(255,255,255,0),rgba(245,249,255,.95));backdrop-filter:blur(10px);border-top:1px solid var(--border)}
      main{padding-bottom:110px}
      #chips{display:flex;flex-wrap:wrap;gap:8px}
    }
    /* Tablet (641‚Äì1024) */
    @media (min-width:641px) and (max-width:1024px){
      .seg-style{display:grid;grid-template-columns:1fr 1fr;gap:14px}
      .seg-length{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
      main{padding-bottom:32px}
    }
    /* Desktop (‚â•1025) */
    @media (min-width:1025px){
      .seg-style{display:grid;grid-template-columns:1fr 1fr;gap:16px}
      .seg-length{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
      main{padding-bottom:32px}
    }
  </style>
</head>
<body>
  <main class="max-w-6xl mx-auto px-5 sm:px-6 pt-6 lg:pt-8 pb-24">
    <!-- HEADER -->
    <div class="flex items-start justify-between gap-4">
      <div class="flex items-start gap-3 sm:gap-4">
        <button onclick="history.back()" class="touch-btn grid place-items-center w-11 h-11 sm:w-12 sm:h-12 rounded-xl border border-[var(--border)] bg-white/80">‚Üê</button>
        <div>
          <h1 class="g-title title-size font-extrabold">Detail Produk & Konfigurasi</h1>
          <p class="text-[var(--muted)] mt-0.5 sm:mt-1 text-sm sm:text-base">Buat skrip promosi afiliasi Anda</p>

          <!-- TOOLBAR mobile/tablet (di bawah judul) -->
          <div class="mt-3 flex flex-col sm:flex-row gap-2 sm:gap-3 lg:hidden">
            <button id="btnGuide_m" class="glass px-4 py-2 rounded-xl text-sm bg-white flex items-center justify-center gap-2 touch-btn">
              <span style="color:#0284c7">‚Ñπ</span> Panduan
            </button>
            <div class="pill px-4 py-2 text-sm flex items-center justify-center gap-2">
              Kuota: <b id="quotaNow_m">‚Äî</b> / 1000
              <button id="btnRefreshQuota_m" class="ml-1 underline text-sky-600 touch-btn">Refresh</button>
            </div>
          </div>
        </div>
      </div>

      <!-- TOOLBAR desktop (kanan) -->
      <div class="hidden lg:flex items-center gap-3">
        <button id="btnGuide" class="glass px-4 py-2 rounded-xl text-sm bg-white flex items-center gap-2 touch-btn">
          <span style="color:#0284c7">‚Ñπ</span> Panduan
        </button>
        <div class="pill px-4 py-2 text-sm">
          Kuota: <b id="quotaNow">‚Äî</b> / 1000
          <button id="btnRefreshQuota" class="ml-1 underline text-sky-600 touch-btn">Refresh</button>
        </div>
      </div>
    </div>

    <!-- PANDUAN -->
    <section id="guidePanel" class="glass mt-4 hidden">
      <div class="px-5 py-3 border-b border-[var(--border)] flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="w-4 h-4 rounded-sm" style="background:linear-gradient(90deg,#60a5fa,#8b5cf6)"></span>
          <h3 class="text-lg sm:text-xl font-extrabold">Panduan Penggunaan</h3>
        </div>
        <button id="closeGuide" class="grid place-items-center w-9 h-9 rounded-lg border border-[var(--border)] bg-white touch-btn">‚úï</button>
      </div>
      <div class="section-pad">
        <ol class="space-y-4 sm:space-y-5 text-[15px] sm:text-[17px] leading-relaxed">
          <li>1. Masukkan <b>link produk</b> & info dasar.</li>
          <li>2. Tambahkan <b>kelebihan/keunggulan</b> (‚â•2).</li>
          <li>3. Pilih <b>gaya bahasa</b> yang sesuai.</li>
          <li>4. Tentukan <b>panjang tulisan</b>.</li>
          <li>5. Klik <b>Mulai Hasilkan</b>.</li>
          <li>6. <b>Salin hasil</b> atau download.</li>
        </ol>
      </div>
    </section>

    <!-- FORM -->
    <section class="glass mt-5 touch-card">
      <div class="px-5 py-3 border-b border-[var(--border)] flex items-center gap-2 bg-white/60">
        <span>üìù</span><h2 class="text-[18px] sm:text-[22px] font-extrabold">Form Input Produk</h2>
      </div>

      <div class="section-pad grid gap-5 sm:gap-6">
        <div>
          <label class="block mb-2 text-[var(--muted)] font-semibold text-sm sm:text-base">Link Produk <span class="text-sky-600">*</span></label>
          <input id="productUrl" type="url" placeholder="https://tokopedia.com/..." class="inp touch-input">
        </div>

        <div>
          <label class="block mb-2 text-[var(--muted)] font-semibold text-sm sm:text-base">Nama / Jenis Produk <span class="text-sky-600">*</span></label>
          <input id="productTopic" type="text" placeholder="Contoh: Smartwatch X Pro" class="inp touch-input">
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="block text-[var(--muted)] font-semibold text-sm sm:text-base">Kelebihan / Keunggulan Produk <span class="text-sky-600">*</span></label>
            <button id="addDescTop" class="hidden sm:inline px-4 py-2 rounded-xl text-white touch-btn" style="background:linear-gradient(90deg,#12b3ff,#7b5cff)">+ Tambah</button>
          </div>
          <input id="descInput" class="inp touch-input" placeholder="Contoh: Tahan Air IP68, Baterai 7 Hari, dll (Enter untuk tambah)">
          <div id="chips" class="mt-2 flex flex-wrap gap-2"></div>
        </div>

        <div>
          <label class="block mb-2 text-[var(--muted)] font-semibold text-sm sm:text-base">Jumlah Variasi Konten</label>
          <input id="count" type="number" min="1" max="10" value="3" class="inp touch-input">
          <p class="text-xs mt-1 text-[var(--muted)]">Antara 1‚Äì10 variasi</p>
        </div>

        <div class="grid gap-6 sm:gap-8">
          <div>
            <label class="block mb-3 text-[var(--muted)] font-semibold">Gaya Bahasa</label>
            <div class="seg seg-style">
              <input type="radio" name="style" id="sty1" value="Santai & Ramah" checked><label for="sty1" class="touch-card">Santai & Ramah</label>
              <input type="radio" name="style" id="sty2" value="Formal & Informatif"><label for="sty2" class="touch-card">Formal & Informatif</label>
              <input type="radio" name="style" id="sty3" value="Promosi Soft Selling"><label for="sty3" class="touch-card">Promosi Soft Selling</label>
              <input type="radio" name="style" id="sty4" value="Penulisan Naskah Iklan (AIDA/PAS)"><label for="sty4" class="touch-card">Penulisan Naskah Iklan (AIDA/PAS)</label>
            </div>
          </div>

          <div>
            <label class="block mb-3 text-[var(--muted)] font-semibold">Panjang Tulisan</label>
            <div class="seg seg-length">
              <input type="radio" name="length" id="len1" value="Pendek (1 paragraf)"><label for="len1" class="touch-card">Pendek (1 paragraf)</label>
              <input type="radio" name="length" id="len2" value="Sedang (2-3 paragraf)" checked><label for="len2" class="touch-card">Sedang (2-3 paragraf)</label>
              <input type="radio" name="length" id="len3" value="Panjang (artikel mini)"><label for="len3" class="touch-card">Panjang (artikel mini)</label>
            </div>
          </div>
        </div>

        <!-- CTA normal (tablet/desktop) -->
        <button id="btnGenerate" class="hidden sm:inline-flex mt-2 w-full items-center justify-center gap-3 px-7 py-5 rounded-2xl text-lg font-extrabold cta touch-btn">
          ‚ú® Mulai Hasilkan
        </button>
        <span id="err" class="text-rose-600"></span>
      </div>
    </section>

    <!-- ACTIONS GLOBAL -->
    <div class="mt-6 flex flex-wrap gap-3">
      <button id="btnDownloadAll" class="px-4 py-2 rounded-xl text-white touch-btn" style="background:#334155">Unduh Semua (.txt)</button>
      <button id="btnExportPDF" class="px-4 py-2 rounded-xl touch-btn" style="background:linear-gradient(90deg,#12b3ff,#7b5cff); color:#fff;">Export PDF</button>
    </div>

    <section id="results" class="mt-6 grid gap-6"></section>
  </main>

  <!-- Sticky CTA untuk HP -->
  <div class="sm:hidden sticky-cta">
    <button id="btnGenerateMobile" class="w-full inline-flex items-center justify-center gap-2 px-5 py-4 rounded-2xl text-base font-extrabold cta touch-btn">
      ‚ú® Mulai Hasilkan
    </button>
  </div>

  <script>
    /* ===== Panel panduan ===== */
    const panel = document.getElementById('guidePanel');
    const openBtns = [document.getElementById('btnGuide'), document.getElementById('btnGuide_m')].filter(Boolean);
    openBtns.forEach(b=> b.addEventListener('click',()=>{ panel.classList.toggle('hidden'); }));
    document.getElementById('closeGuide').addEventListener('click',()=> panel.classList.add('hidden'));

    /* ===== Kuota ===== */
    async function loadQuota(){
      try{
        const r=await fetch('/api/quota'); const j=await r.json();
        const val = j?.remaining ?? '‚Äî';
        ['quotaNow','quotaNow_m'].forEach(id=>{const el=document.getElementById(id); if(el) el.textContent=val;});
      }catch{
        ['quotaNow','quotaNow_m'].forEach(id=>{const el=document.getElementById(id); if(el) el.textContent='‚Äî';});
      }
    }
    ;['btnRefreshQuota','btnRefreshQuota_m'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.addEventListener('click', loadQuota);
    });
    loadQuota();

    /* ===== Chips kelebihan ===== */
    const chipsEl=document.getElementById('chips'); const inputEl=document.getElementById('descInput');
    const btnTop=document.getElementById('addDescTop'); let chips=[];
    const renderChips=()=>{chipsEl.innerHTML='';chips.forEach((t,i)=>{const s=document.createElement('span');s.className='inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm';s.style.cssText='background:#eef2ff;border:1px solid var(--border)';s.innerHTML=`${escapeHtml(t)} <button data-i="${i}" class="text-[var(--muted)]">‚úï</button>`;s.querySelector('button').onclick=e=>{chips.splice(+e.target.dataset.i,1);renderChips()};chipsEl.appendChild(s);})};
    const addChip=()=>{const v=inputEl.value.trim(); if(!v) return; chips.push(v); inputEl.value=''; renderChips();};
    inputEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addChip(); }});
    btnTop?.addEventListener('click', addChip);

    /* ===== Emoji formatter: rapi & terstruktur ===== */
    function formatEmojisNeatly(raw) {
      if (!raw) return '';
      let text = String(raw).replace(/\r\n/g, '\n').replace(/\t/g,' ').replace(/[ \u00A0]+/g,' ');
      const paras = text.split(/\n{2,}/).map(s => s.trim()).filter(Boolean);

      const bulletPool = ['üöÄ','‚ú®','üí°','üåü','‚úÖ'];
      const hasLeadEmoji = (s) => /^[^\w]*(?:üöÄ|‚ú®|üí°|üåü|‚úÖ|üìå|üí•|üî•)/.test(s);

      // bullet hanya di paragraf pertama
      if (paras.length && !hasLeadEmoji(paras[0])) {
        paras[0] = `${bulletPool[0]} ${paras[0]}`;
      }

      const ctaRegexes = [
        /\b(cek|lihat|kunjungi|beli|pesan|klik)\b(?:\s+(selengkapnya|detail|tautan|link|di\s*sini|sekarang))?/gi
      ];
      const urlRegex = /(https?:\/\/[^\s\])>]+[^\s\])]*)/gi;

      const enhance = (p) => {
        let s = p;
        s = s.replace(/\s*([,.;:!?])\s*/g, '$1 ');

        // tambahkan üëâ di frasa CTA
        ctaRegexes.forEach(re => {
          s = s.replace(re, (m) => (/üëâ/.test(m) ? m : `${m} üëâ`));
        });

        // URL ke baris baru dengan üëâ
        s = s.replace(urlRegex, (m) => `\nüëâ ${m}`);

        s = s.replace(/üëâ(?:\s*üëâ)+/g, 'üëâ');
        return s.trim();
      };

      return paras.map(enhance).join('\n\n');
    }

    /* ===== Generate ===== */
    async function doGenerate(btn){
      const err=document.getElementById('err'); err.textContent='';
      const url=document.getElementById('productUrl').value.trim();
      const topic=document.getElementById('productTopic').value.trim();
      const style=document.querySelector('input[name="style"]:checked')?.value || 'Santai & Ramah';
      const length=document.querySelector('input[name="length"]:checked')?.value || 'Sedang (2-3 paragraf)';
      const count=Math.max(1,Math.min(10, Number(document.getElementById('count').value || 3)));
      const descriptions=[...chips];
      if(!url) return err.textContent='Link Produk wajib diisi.';
      if(!topic) return err.textContent='Nama / Jenis Produk wajib diisi.';
      if(descriptions.length<2) return err.textContent='Minimal 2 kelebihan / keunggulan.';
      const original=btn.innerHTML; btn.disabled=true; btn.innerHTML='‚è≥ Tunggu sebentar‚Ä¶  AI sedang meracik kata-kata untuk Anda...';

      try{
        const r=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ linkProduk:url, topik:topic, deskripsi:descriptions, gaya:style, panjang:length, jumlah:count,
            link:url, topic, descriptions, style, length, generateCount:count, count })
        });
        const raw=await r.text(); let j=null; try{ j=raw? JSON.parse(raw): null }catch{};
        if(!r.ok || !j || !j.ok) throw new Error(j?.message || raw || 'Gagal generate');
        renderResults(j.scripts||[]); loadQuota();
      }catch(e){ err.textContent=e.message; }
      finally{ btn.disabled=false; btn.innerHTML=original; }
    }
    document.getElementById('btnGenerate')?.addEventListener('click', function(){ doGenerate(this) });
    document.getElementById('btnGenerateMobile')?.addEventListener('click', function(){ doGenerate(this) });

    /* ===== Render hasil ===== */
    function renderResults(scripts){
      const box=document.getElementById('results'); box.innerHTML='';

      scripts.forEach((s,i)=>{
        const title=(s.title||'').trim();
        const content=formatEmojisNeatly((s.content||'').trim());

        const card=document.createElement('div'); 
        card.className='glass p-5 sm:p-6 touch-card';
        card.innerHTML=`
          <h3 class="text-xl sm:text-2xl font-extrabold text-blue-600 mb-3">${escapeHtml(title)}</h3>
          <p class="whitespace-pre-wrap leading-relaxed text-[15px] sm:text-base" data-body>${escapeHtml(content)}</p>
          <div class="mt-4 flex gap-2 justify-end">
            <button class="px-4 py-2 rounded-lg text-white touch-btn" style="background:#334155" data-copy>Salin</button>
            <button class="px-4 py-2 rounded-lg touch-btn" style="background:#e5e7eb" data-edit>Edit</button>
          </div>
        `;

        card.querySelector('[data-copy]').onclick=()=>{
          const b=card.querySelector('[data-body]').innerText;
          navigator.clipboard.writeText(b).then(()=>{
            const btn=card.querySelector('[data-copy]'); btn.textContent='Tersalin!'; setTimeout(()=>btn.textContent='Salin',1400);
          });
        };
        card.querySelector('[data-edit]').onclick=()=>{
          const current = card.querySelector('[data-body]').innerText;
          openEditModal(current,(next)=>{ card.querySelector('[data-body]').textContent = next; });
        };
        box.appendChild(card);
      });

      if (window.innerWidth <= 640 && scripts.length) window.scrollTo({ top: box.offsetTop - 64, behavior: 'smooth' });
    }

    /* ===== Modal Edit (textarea nyaman) ===== */
    function openEditModal(initial, onSave){
      const wrap = document.createElement('div');
      wrap.style.cssText = `position:fixed; inset:0; background:rgba(2,6,23,.42); z-index:60; display:grid; place-items:center; padding:16px`;
      wrap.innerHTML = `
        <div style="max-width:780px; width:100%; background:white; border-radius:16px; border:1px solid #e5e7eb; box-shadow:0 22px 60px rgba(2,6,23,.2);">
          <div style="padding:18px 20px; border-bottom:1px solid #eef2ff; font-weight:800; font-size:18px;">Edit konten</div>
          <div style="padding:16px 20px;">
            <textarea id="__editArea" class="touch-textarea" style="width:100%; height:220px; padding:14px 16px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; resize:vertical; font: 15px/1.6 Inter, system-ui, sans-serif;"></textarea>
          </div>
          <div style="padding:14px 20px; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid #eef2ff;">
            <button id="__ok"   class="touch-btn" style="background:linear-gradient(90deg,#12b3ff,#7b5cff); color:#fff; padding:10px 16px; border-radius:10px; font-weight:800;">Simpan</button>
            <button id="__cancel" class="touch-btn" style="background:#f1f5f9; padding:10px 16px; border-radius:10px; font-weight:700;">Batal</button>
          </div>
        </div>
      `;
      document.body.appendChild(wrap);
      const ta = wrap.querySelector('#__editArea'); ta.value = initial;
      wrap.querySelector('#__ok').onclick = ()=>{ onSave(ta.value); document.body.removeChild(wrap); };
      wrap.querySelector('#__cancel').onclick = ()=> document.body.removeChild(wrap);
    }

    /* ===== Unduh semua (.txt) ===== */
    document.getElementById('btnDownloadAll').addEventListener('click', ()=>{
      const cards=[...document.querySelectorAll('#results [data-body]')];
      if(!cards.length) return alert('Belum ada hasil.');
      const txt=cards.map((el,idx)=>{
        const title=el.closest('.glass').querySelector('h3')?.innerText||`Variasi ${idx+1}`;
        return `${title}\n${el.innerText}\n`;
      }).join('\n------------------------\n\n');
      const blob=new Blob([txt],{type:'text/plain'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='skrip-affiliasi.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    /* ===== Export PDF (via print window) ===== */
    document.getElementById('btnExportPDF').addEventListener('click', ()=>{
      const cards=[...document.querySelectorAll('#results .glass')];
      if(!cards.length) return alert('Belum ada hasil.');
      const html=cards.map((c)=>`<div style="margin-bottom:18px;padding:16px;border:1px solid #e5e7eb;border-radius:12px">
        <h3 style="margin:0 0 8px 0;font:700 18px Inter;color:#2563eb;">${c.querySelector('h3')?.innerText||''}</h3>
        <pre style="white-space:pre-wrap;margin:0;font:400 14px/1.6 Inter;color:#0f172a">${c.querySelector('[data-body]')?.innerText||''}</pre>
      </div>`).join('');
      const w=window.open('','_blank','width=1000,height=800');
      w.document.write(`<!doctype html><html><head><title>Export PDF</title></head>
      <body style="margin:24px;background:#fff;font-family:Inter,system-ui">
      <h1 style="font:800 22px Inter;margin:0 0 16px 0">Hasil Skrip</h1>
      ${html}
      <script>window.onload=()=>{setTimeout(()=>window.print(),250)}</script>
      </body></html>`);
      w.document.close();
    });

    function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
  </script>
</body>
</html>
