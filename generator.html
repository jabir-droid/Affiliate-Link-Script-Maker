<!DOCTYPE html>
<html lang="id" data-theme="auto">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Detail Produk & Konfigurasi</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#475569;
      --panel:rgba(255,255,255,.86); --border:rgba(15,23,42,.12);
      --grad1:#6a5cff; --grad2:#2fb7ff; --cta:#ff7a1a; --shadow:rgba(47,183,255,.28);
    }
    html[data-theme="dark"]{
      --bg:#0b1220; --fg:#e5e7eb; --muted:#b6c2d2;
      --panel:rgba(7,12,22,.74); --border:rgba(148,163,184,.18); --shadow:rgba(106,92,255,.35);
    }
    html[data-theme="night"]{
      --bg:#060b16; --fg:#f1f5f9; --muted:#c9d3e6;
      --panel:rgba(4,8,18,.72); --border:rgba(148,163,184,.22); --shadow:rgba(111,196,255,.42);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--fg);background:var(--bg);
      background:
        radial-gradient(1100px 520px at 0% -10%, rgba(106,92,255,.16), transparent 60%),
        radial-gradient(1100px 520px at 100% 0%, rgba(47,183,255,.14), transparent 60%),
        url("/bg/landing-city.jpg") center/cover fixed no-repeat;
      transition:background-color .3s ease,color .3s ease,opacity .25s ease,transform .25s ease;
      opacity:0;transform:translateY(6px);
    }
    body.ready{opacity:1;transform:none}
    body.leaving{opacity:0;transform:translateY(6px)}

    .container{max-width:1120px;margin:0 auto;padding:22px 18px 120px}
    .glass{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 20px 52px var(--shadow);backdrop-filter:blur(10px)}
    .pill{background:#f3f6ff;border:1px solid var(--border);border-radius:12px;padding:10px 14px}
    html[data-theme="dark"] .pill,html[data-theme="night"] .pill{background:rgba(255,255,255,.04)}
    .title-grad{background:linear-gradient(90deg,var(--grad2),var(--grad1));-webkit-background-clip:text;background-clip:text;color:transparent}
    .h1{font-size:clamp(26px,4.6vw,44px);line-height:1.08;letter-spacing:-.02em;margin:0}
    .muted{color:var(--muted)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 18px;border-radius:14px;border:1px solid transparent;font-weight:800;cursor:pointer}
    .btn-ghost{background:var(--panel);border:1px solid var(--border)}
    .btn-primary{background:linear-gradient(90deg,var(--grad2),var(--grad1));color:#fff;box-shadow:0 18px 45px var(--shadow)}
    .btn-cta{background:var(--cta);color:#fff}
    .inp{width:100%;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.7);padding:14px 16px;outline:none;color:inherit}
    html[data-theme="dark"] .inp,html[data-theme="night"] .inp{background:rgba(255,255,255,.05)}
    .inp:focus{border-color:#4ea8ff;box-shadow:0 0 0 3px rgba(78,168,255,.18)}
    .seg input{display:none}
    .seg label{border:1px solid var(--border);background:rgba(255,255,255,.7);padding:14px 16px;border-radius:16px;cursor:pointer;text-align:center;font-weight:600}
    html[data-theme="dark"] .seg label,html[data-theme="night"] .seg label{background:rgba(255,255,255,.06)}
    .seg input:checked+label{background:linear-gradient(90deg,rgba(18,179,255,.18),rgba(124,92,255,.18));border-color:#7c5cff;box-shadow:0 0 18px rgba(124,92,255,.20)}
    .seg-style,.seg-length{display:grid;gap:14px}
    @media(min-width:720px){.seg-style{grid-template-columns:1fr 1fr}.seg-length{grid-template-columns:1fr 1fr 1fr}}
    .sp{padding:clamp(16px,2.8vw,28px)}
    footer{text-align:center;color:var(--muted);margin-top:18px}
    .sticky{position:fixed;left:0;right:0;bottom:0;padding:12px 16px calc(env(safe-area-inset-bottom) + 14px);background:linear-gradient(180deg,rgba(255,255,255,0),var(--panel));backdrop-filter:blur(10px);border-top:1px solid var(--border)}

    /* Loading overlay */
    .overlay{position:fixed;inset:0;background:rgba(3,6,15,.82);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:50;color:#eaf2ff}
    .card{max-width:980px;margin:0 auto;padding:28px;border-radius:20px;background:rgba(7,12,22,.35);border:1px solid rgba(255,255,255,.12)}
    .halo{width:180px;height:180px;border-radius:50%;margin:0 auto 18px;background:radial-gradient(circle at 50% 40%, #2fb7ff 0%, #6a5cff 60%, transparent 62%)}
    .pulse{animation:pulse 1.8s ease-in-out infinite}
    @keyframes pulse{0%{transform:scale(.96);opacity:.88}50%{transform:scale(1);opacity:1}100%{transform:scale(.96);opacity:.88}}

    .res{border:1px solid var(--border);border-radius:16px;padding:14px;background:rgba(255,255,255,.7)}
    html[data-theme="dark"] .res,html[data-theme="night"] .res{background:rgba(255,255,255,.05)}
    .res-toolbar{display:flex;gap:8px;justify-content:flex-end}
    .editbox{width:100%;height:140px;border:1px dashed var(--border);border-radius:12px;background:transparent;color:inherit;padding:10px 12px}
  </style>
</head>
<body>
  <!-- Theme toggles -->
  <div style="position:fixed;right:14px;top:14px;z-index:30;display:flex;gap:8px">
    <button class="btn btn-ghost" id="tAuto">Auto</button>
    <button class="btn btn-ghost" id="tLight">Light</button>
    <button class="btn btn-ghost" id="tDark">Dark</button>
    <button class="btn btn-ghost" id="tNight">Night</button>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="row" style="gap:14px;flex-wrap:wrap">
      <div class="row" style="gap:12px">
        <button onclick="goBack()" class="btn btn-ghost" title="Kembali">‚Üê</button>
        <div>
          <h1 class="h1 title-grad">Detail Produk & Konfigurasi</h1>
          <div class="muted" style="margin-top:4px">Buat skrip promosi afiliasi Anda</div>
          <div class="row" style="gap:10px;margin-top:10px;flex-wrap:wrap">
            <button id="btnGuide_m" class="btn btn-ghost">‚Ñπ Panduan</button>
            <div class="pill">Kuota: <b id="quota_m">‚Äî</b> / 1000 <button id="qRefresh_m" class="btn" style="padding:6px 10px;border-radius:10px">Refresh</button></div>
          </div>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <button id="btnGuide" class="btn btn-ghost">‚Ñπ Panduan</button>
        <div class="pill">Kuota: <b id="quota">‚Äî</b> / 1000 <button id="qRefresh" class="btn" style="padding:6px 10px;border-radius:10px">Refresh</button></div>
      </div>
    </div>

    <!-- Panduan -->
    <section id="guide" class="glass sp" style="margin-top:12px;display:none">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div class="row" style="gap:10px"><span style="width:14px;height:14px;border-radius:3px;background:linear-gradient(90deg,var(--grad2),var(--grad1))"></span>
          <strong>Panduan Penggunaan</strong></div>
        <button id="gClose" class="btn btn-ghost">‚úï</button>
      </div>
      <ol style="line-height:1.85;margin:0;padding-left:18px">
        <li>Masukkan <b>link produk</b> & info dasar.</li>
        <li>Tambahkan <b>kelebihan/keunggulan</b> (‚â•1).</li>
        <li>Pilih <b>gaya bahasa</b> yang sesuai.</li>
        <li>Tentukan <b>panjang tulisan</b>.</li>
        <li>Klik <b>Mulai Hasilkan</b>.</li>
        <li><b>Salin hasil</b> atau download.</li>
      </ol>
    </section>

    <!-- Form -->
    <section class="glass sp" style="margin-top:16px">
      <h3 style="margin:0 0 12px;display:flex;align-items:center;gap:8px">üìù <span class="title-grad" style="font-weight:800">Form Input Produk</span></h3>
      <div style="display:grid;gap:16px">
        <div>
          <label class="muted" style="display:block;margin-bottom:6px;font-weight:600">Link Produk <span style="color:#0ea5e9">*</span></label>
          <input id="url" type="url" class="inp" placeholder="https://tokopedia.com/..." />
        </div>
        <div>
          <label class="muted" style="display:block;margin-bottom:6px;font-weight:600">Nama / Jenis Produk <span style="color:#0ea5e9">*</span></label>
          <input id="topic" type="text" class="inp" placeholder="Contoh: Smartwatch X Pro" />
        </div>
        <div>
          <div class="row" style="justify-content:space-between;margin-bottom:6px">
            <label class="muted" style="font-weight:600">Kelebihan / Keunggulan Produk <span style="color:#0ea5e9">*</span></label>
            <button id="addChip" class="btn btn-primary" style="padding:10px 14px;border-radius:12px">+ Tambah</button>
          </div>
          <input id="chipInput" class="inp" placeholder="Contoh: Tahan Air IP68, Baterai 7 Hari (Enter untuk menambah)" />
          <div id="chips" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px"></div>
        </div>
        <div>
          <label class="muted" style="display:block;margin-bottom:6px;font-weight:600">Jumlah Variasi Konten</label>
          <input id="count" type="number" min="1" max="10" value="3" class="inp" />
        </div>
        <div style="display:grid;gap:18px">
          <div>
            <label class="muted" style="display:block;margin-bottom:10px;font-weight:600">Gaya Bahasa</label>
            <div class="seg seg-style">
              <input type="radio" name="style" id="s1" value="Santai & Ramah" checked><label for="s1">Santai & Ramah</label>
              <input type="radio" name="style" id="s2" value="Formal & Informatif"><label for="s2">Formal & Informatif</label>
              <input type="radio" name="style" id="s3" value="Promosi Soft Selling"><label for="s3">Promosi Soft Selling</label>
              <input type="radio" name="style" id="s4" value="Penulisan Naskah Iklan (AIDA/PAS)"><label for="s4">Penulisan Naskah Iklan (AIDA/PAS)</label>
            </div>
          </div>
          <div>
            <label class="muted" style="display:block;margin-bottom:10px;font-weight:600">Panjang Tulisan</label>
            <div class="seg seg-length">
              <input type="radio" name="length" id="l1" value="Pendek (1 paragraf)"><label for="l1">Pendek (1 paragraf)</label>
              <input type="radio" name="length" id="l2" value="Sedang (2-3 paragraf)" checked><label for="l2">Sedang (2-3 paragraf)</label>
              <input type="radio" name="length" id="l3" value="Panjang (artikel mini)"><label for="l3">Panjang (artikel mini)</label>
            </div>
          </div>
        </div>

        <div id="err" style="color:#ef4444;font-weight:600"></div>
        <button id="go" class="btn btn-primary" style="width:100%;font-size:18px;border-radius:16px">‚ú® Mulai Hasilkan</button>
      </div>
    </section>

    <!-- Actions setelah hasil -->
    <div id="bulkBar" class="row" style="gap:10px;margin-top:16px;display:none;flex-wrap:wrap">
      <button id="exportWord" class="btn btn-cta">‚¨á Export Semua ke Word</button>
    </div>

    <!-- Results -->
    <section id="results" style="display:grid;gap:14px;margin-top:14px"></section>

    <footer>¬© 2025 ‚Äî <span id="cpy">Dibuat untuk Mempermudah promosi afiliasi.</span></footer>
  </div>

  <div class="sticky" id="stickyCta">
    <button class="btn btn-primary" style="width:100%;font-size:16px;border-radius:14px" id="goMobile">‚ú® Mulai Hasilkan</button>
  </div>

  <div class="overlay" id="loading">
    <div class="card">
      <div class="halo pulse"></div>
      <h2 style="text-align:center;margin:6px 0 4px;font-size:clamp(22px,4.2vw,34px)">
        <span style="filter:drop-shadow(0 4px 18px rgba(47,183,255,.4))">üí¨</span>
        <span style="background:linear-gradient(90deg,#2fb7ff,#6a5cff);-webkit-background-clip:text;background-clip:text;color:transparent">AI Sedang Bekerja‚Ä¶</span>
      </h2>
      <p style="text-align:center;margin:8px 0 0;color:#cfe8ff;font-size:clamp(14px,2.2vw,18px)">Meracik kata-kata terbaik untuk Anda</p>
      <p style="text-align:center;margin:10px 0 0;color:#9ec3ff"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#2fb7ff;margin-right:8px" class="pulse"></span>Mohon tunggu sebentar‚Ä¶</p>
    </div>
  </div>

  <script>
    // mount / fade
    window.addEventListener('load',()=>document.body.classList.add('ready'));
    function goBack(){ document.body.classList.add('leaving'); setTimeout(()=>history.back(),180); }

    // theme
    const setTheme=(m)=>{document.documentElement.setAttribute('data-theme', m==='auto'?(matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'):m);localStorage.setItem('theme_pref',m);}
    ;[['tAuto','auto'],['tLight','light'],['tDark','dark'],['tNight','night']].forEach(([id,m])=>document.getElementById(id).onclick=()=>setTheme(m));
    setTheme(localStorage.getItem('theme_pref')||'auto');
    matchMedia('(prefers-color-scheme:dark)').addEventListener('change',()=>{if((localStorage.getItem('theme_pref')||'auto')==='auto')setTheme('auto')});

    // guide toggle
    const guide=document.getElementById('guide');
    document.getElementById('btnGuide').onclick=()=>guide.style.display=guide.style.display==='none'?'block':'none';
    document.getElementById('btnGuide_m').onclick=()=>guide.style.display=guide.style.display==='none'?'block':'none';
    document.getElementById('gClose').onclick=()=>guide.style.display='none';

    // quota
    async function loadQuota(){
      try{const r=await fetch('/api/quota');const j=await r.json();['quota','quota_m'].forEach(id=>{const el=document.getElementById(id); if(el) el.textContent=j?.remaining ?? '‚Äî';});}
      catch{['quota','quota_m'].forEach(id=>{const el=document.getElementById(id); if(el) el.textContent='‚Äî';});}
    }
    loadQuota();
    document.getElementById('qRefresh').onclick=loadQuota;
    document.getElementById('qRefresh_m').onclick=loadQuota;

    // chips
    const chipsEl=document.getElementById('chips'), chipInput=document.getElementById('chipInput'); let chips=[];
    function renderChips(){chipsEl.innerHTML=''; chips.forEach((t,i)=>{const s=document.createElement('span'); s.style.cssText='display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.75)'; s.innerHTML=`${escapeHtml(t)} <button data-i="${i}" title="Hapus" style="border:none;background:none;color:var(--muted);cursor:pointer">‚úï</button>`; s.querySelector('button').onclick=e=>{chips.splice(+e.target.dataset.i,1);renderChips();}; chipsEl.appendChild(s);});}
    chipInput.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addChip(); }});
    document.getElementById('addChip').onclick=addChip;
    function addChip(){const v=chipInput.value.trim(); if(!v) return; chips.push(v); chipInput.value=''; renderChips();}

    // generate
    const btnDesktop=document.getElementById('go'), btnMobile=document.getElementById('goMobile'), loading=document.getElementById('loading');
    function getSel(name){const el=document.querySelector(`input[name="${name}"]:checked`); return el? el.value : '';}
    async function doGenerate(){
      const err=document.getElementById('err'); err.textContent='';
      const url=document.getElementById('url').value.trim();
      const topic=document.getElementById('topic').value.trim();
      const style=getSel('style') || 'Santai & Ramah';
      const length=getSel('length') || 'Sedang (2-3 paragraf)';
      const count=Math.max(1,Math.min(10, Number(document.getElementById('count').value||3)));
      if(!url) return err.textContent='Link Produk wajib diisi.';
      if(!topic) return err.textContent='Nama / Jenis Produk wajib diisi.';
      if(chips.length<1) return err.textContent='Minimal 1 kelebihan / keunggulan.';
      loading.style.display='flex';
      try{
        const r=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
          linkProduk:url, topik:topic, deskripsi:chips, gaya:style, panjang:length, jumlah:count,
          link:url, topic, descriptions:chips, style, length, generateCount:count, count
        })});
        const raw=await r.text(); let j=null; try{ j=raw? JSON.parse(raw): null }catch{};
        if(!r.ok || !j || !j.ok) throw new Error(j?.message || raw || 'Gagal generate');
        renderResults(j.scripts||[]); loadQuota();
      }catch(e){ err.textContent=e.message; }
      finally{ loading.style.display='none'; }
    }
    btnDesktop.onclick=doGenerate; btnMobile.onclick=doGenerate;

    // render + export
    let currentScripts=[];
    function renderResults(list){
      currentScripts=list.map(x=>({title:x.title||'',content:x.content||''}));
      const box=document.getElementById('results'); box.innerHTML='';
      document.getElementById('bulkBar').style.display=list.length?'flex':'none';
      list.forEach((s,i)=>{
        const wrap=document.createElement('div'); wrap.className='res';
        wrap.innerHTML=`<h4 style="margin:0 0 6px;color:#3b82f6">Variasi ${i+1} ‚Ä¢ ${escapeHtml(s.title||'')}</h4>
          <div data-view style="white-space:pre-wrap;line-height:1.7">${escapeHtml(s.content||'')}</div>
          <textarea data-edit class="editbox" style="display:none">${escapeHtml(s.content||'')}</textarea>
          <div class="res-toolbar" style="margin-top:10px">
            <button data-copy class="btn btn-ghost">Salin</button>
            <button data-editbtn class="btn btn-ghost">Edit</button>
          </div>`;
        const view=wrap.querySelector('[data-view]'), edit=wrap.querySelector('[data-edit]'), ebtn=wrap.querySelector('[data-editbtn]');
        wrap.querySelector('[data-copy]').onclick=()=>navigator.clipboard.writeText(edit.style.display==='none'?(s.content||''):edit.value).then(()=>{const b=wrap.querySelector('[data-copy]'); b.textContent='Tersalin!'; setTimeout(()=>b.textContent='Salin',1400);});
        ebtn.onclick=()=>{ if(edit.style.display==='none'){ edit.style.display='block'; view.style.display='none'; ebtn.textContent='Selesai'; } else { edit.style.display='none'; view.style.display='block'; view.textContent=edit.value; currentScripts[i].content=edit.value; ebtn.textContent='Edit'; } };
        box.appendChild(wrap);
      });
      if (window.innerWidth <= 640 && list.length) window.scrollTo({top: box.offsetTop - 64, behavior:'smooth'});
    }
    function exportWord(){
      if(!currentScripts.length) return;
      const safe=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const items=currentScripts.map((s,i)=>`<h2 style="font-family:Inter,sans-serif;color:#1f2937">Variasi ${i+1} ‚Äî ${safe(s.title)}</h2><pre style="white-space:pre-wrap;font-family:Inter,sans-serif;color:#111827">${safe(s.content)}</pre><hr/>`).join('');
      const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Hasil Skrip</title></head><body>${items}</body></html>`;
      const blob=new Blob(['\ufeff',html],{type:'application/msword'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='Skrip_Afiliasi.doc'; a.click(); URL.revokeObjectURL(a.href);
    }
    document.getElementById('exportWord').onclick=exportWord;

    // utils
    function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  </script>
</body>
</html>
