<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Affiliate Link Script Maker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-doc-js@1.1.0/dist/html-doc.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; transition: background-color .3s, color .3s; }
    .card { transition: all .3s ease-in-out; border: 1px solid rgba(255,255,255,.1); }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / .1), 0 4px 6px -4px rgb(0 0 0 / .1); }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.5rem 1rem; border-radius:.5rem; font-weight:500; transition:all .2s; }
    .btn-primary { background:#4f46e5; color:#fff; }
    .btn-primary:hover { background:#4338ca; box-shadow:0 4px 14px 0 rgba(79,70,229,.39); }
    #loader { border:4px solid #4a5568; border-top:4px solid #4f46e5; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  </style>
</head>
<body class="bg-slate-900 text-gray-200">
  <div class="container mx-auto p-4 md:p-8 max-w-4xl relative">
    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-sky-400 to-indigo-400 bg-clip-text text-transparent">
        Affiliate Link Script Maker
      </h1>
      <p class="mt-2 text-lg text-gray-300">
        Generator skrip affiliasi tercepat! Tempel link produk, salin skripnya, dan pasang di web atau media sosial Anda tanpa ribet.
      </p>
    </header>

    <!-- Main Card -->
    <div class="card p-6 md:p-8 mb-8 bg-slate-800/50 backdrop-blur-xl border-slate-700">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Link Produk -->
        <div class="md:col-span-2">
          <label for="productUrl" class="block text-sm font-medium text-gray-300 mb-1">Link Produk (Wajib)</label>
          <input type="url" id="productUrl" placeholder="Tempelkan link produk afiliasi Anda di sini..." class="w-full p-2 border border-slate-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-slate-700 placeholder-gray-400">
        </div>

        <!-- Gambar Produk (opsional, hanya untuk preview di UI) -->
        <div class="md:col-span-2">
          <label for="productImage" class="block text-sm font-medium text-gray-300 mb-1">Foto Produk (Opsional)</label>
          <div class="flex items-center gap-4">
            <input type="file" id="productImage" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-600">
            <img id="imagePreview" src="https://placehold.co/100x100/1e293b/a3a3a3?text=Preview" alt="Image Preview" class="w-16 h-16 rounded-md object-cover border-2 border-slate-600">
          </div>
        </div>

        <!-- Pengaturan -->
        <div>
          <label for="generateCount" class="block text-sm font-medium text-gray-300 mb-1">Jumlah Hasil</label>
          <input type="number" id="generateCount" value="2" min="1" max="5" class="w-full p-2 border border-slate-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-slate-700">
        </div>
        <div>
          <label for="languageStyle" class="block text-sm font-medium text-gray-300 mb-1">Gaya Bahasa</label>
          <select id="languageStyle" class="w-full p-2 border border-slate-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-slate-700">
            <option value="Persuasif & Menjual">Persuasif & Menjual</option>
            <option value="Informatif & Edukatif">Informatif & Edukatif</option>
            <option value="Santai & Kasual">Santai & Kasual</option>
            <option value="Ulasan Jujur">Ulasan Jujur</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label for="contentLength" class="block text-sm font-medium text-gray-300 mb-1">Panjang Tulisan</label>
          <select id="contentLength" class="w-full p-2 border border-slate-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-slate-700">
            <option value="Pendek (caption sosial media)">Pendek (~50 kata)</option>
            <option value="Sedang (deskripsi video)">Sedang (~150 kata)</option>
            <option value="Panjang (artikel blog)">Panjang (300+ kata)</option>
          </select>
        </div>
      </div>

      <!-- Tombol -->
      <div class="mt-8 text-center">
        <button id="generateBtn" class="btn btn-primary w-full md:w-auto px-8 py-3 text-lg transform hover:scale-105">
          <i data-lucide="sparkles" class="w-5 h-5"></i>
          <span>Generate Script!</span>
        </button>
      </div>
    </div>

    <!-- Output -->
    <div id="outputSection" class="space-y-6">
      <div id="loaderContainer" class="hidden justify-center items-center flex-col text-center">
        <div id="loader"></div>
        <p class="mt-4 text-gray-400 font-medium">AI sedang meracik kata-kata... Mohon tunggu sebentar.</p>
      </div>
    </div>

    <!-- Error -->
    <div id="error-message" class="hidden card bg-red-900/20 border-red-500/30 p-4 text-center mt-6">
      <p class="font-semibold text-red-400">Oops, terjadi kesalahan!</p>
      <p id="error-text" class="text-red-400 text-sm mt-1"></p>
    </div>
  </div>

  <script type="module">
    // ====== KONFIGURASI BACKEND ======
    // Jika UI di GitHub Pages: pakai domain Vercel penuh
    const API_BASE = 'https://affiliate-link-script-maker.vercel.app/api';
    // Jika UI juga di-deploy di Vercel (origin sama), ganti ke:
    // const API_BASE = '/api';

    const { jsPDF } = window.jspdf;

    // ====== Ambil elemen ======
    const generateBtn = document.getElementById('generateBtn');
    const outputSection = document.getElementById('outputSection');
    const loaderContainer = document.getElementById('loaderContainer');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const productImageInput = document.getElementById('productImage');
    const imagePreview = document.getElementById('imagePreview');

    // Icons
    lucide.createIcons();

    // ====== Preview Gambar (untuk UI saja) ======
    productImageInput.addEventListener('change', () => {
      const file = productImageInput.files[0];
      if (!file) {
        imagePreview.src = 'https://placehold.co/100x100/1e293b/a3a3a3?text=Preview';
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => imagePreview.src = e.target.result;
      reader.readAsDataURL(file);
    });

    // ====== Util ======
    function showError(msg) {
      errorText.textContent = msg;
      errorMessage.classList.remove('hidden');
    }
    function hideError() {
      errorMessage.classList.add('hidden');
    }
    function startLoading() {
      loaderContainer.classList.remove('hidden');
      loaderContainer.classList.add('flex');
      generateBtn.disabled = true;
      generateBtn.classList.add('opacity-50','cursor-not-allowed');
    }
    function stopLoading() {
      loaderContainer.classList.add('hidden');
      loaderContainer.classList.remove('flex');
      generateBtn.disabled = false;
      generateBtn.classList.remove('opacity-50','cursor-not-allowed');
    }

    // ====== Render hasil ======
    function renderResults(cards) {
      outputSection.innerHTML = '';
      if (!cards.length) {
        outputSection.innerHTML = `<p class="text-center text-gray-400">AI tidak dapat menghasilkan skrip. Coba lagi.</p>`;
        return;
      }
      cards.forEach(({title, content, imageData}, idx) => {
        const card = document.createElement('div');
        card.className = 'card p-6 bg-slate-800/50 backdrop-blur-xl border-slate-700';
        card.innerHTML = `
          ${imageData ? `<img src="${imageData}" alt="Pratinjau Produk" class="w-full h-auto object-cover rounded-lg mb-4 border border-slate-700">` : ''}
          <h3 class="text-lg font-semibold text-indigo-400 mb-2">${title}</h3>
          <div id="content-${idx}" class="text-gray-300 whitespace-pre-wrap">${content}</div>
          <div class="mt-4 flex flex-wrap gap-2 justify-end">
            <button class="btn bg-slate-700 text-gray-200 hover:bg-slate-600 copy-btn" data-index="${idx}">
              <i data-lucide="copy" class="w-4 h-4"></i><span class="btn-text">Salin</span>
            </button>
            <button class="btn bg-slate-700 text-gray-200 hover:bg-slate-600 export-word-btn" data-index="${idx}">
              <i data-lucide="file-down" class="w-4 h-4"></i><span>Export Word</span>
            </button>
            <button class="btn bg-slate-700 text-gray-200 hover:bg-slate-600 export-pdf-btn" data-index="${idx}">
              <i data-lucide="file-text" class="w-4 h-4"></i><span>Export PDF</span>
            </button>
          </div>
        `;
        outputSection.appendChild(card);
      });
      lucide.createIcons();
    }

    // ====== Handler tombol Generate ======
    generateBtn.addEventListener('click', async () => {
      hideError();

      const productUrl = document.getElementById('productUrl').value.trim();
      const generateCount = Math.max(1, Math.min(5, parseInt(document.getElementById('generateCount').value || '1', 10)));
      const languageStyle = document.getElementById('languageStyle').value;
      const contentLength = document.getElementById('contentLength').value;
      const imageFile = productImageInput.files?.[0];

      if (!productUrl) return showError('Mohon isi Link Produk untuk melanjutkan.');
      try { new URL(productUrl) } catch { return showError('Link Produk yang Anda masukkan tidak valid.'); }

      // siapkan preview gambar untuk rendering (tidak dikirim ke backend)
      let imageForRendering = '';
      if (imageFile) {
        imageForRendering = await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(imageFile);
        });
      }

      outputSection.innerHTML = '';
      startLoading();

      try {
        // Backend kamu menghasilkan 1 skrip tiap panggilan.
        // Untuk N hasil, kita panggil endpoint N kali paralel.
        const payload = {
          linkProduk: productUrl,
          fotoUrl: imageForRendering || '', // hanya untuk konteks prompt di server
          gaya: languageStyle,
          panjang: contentLength
        };

        const calls = Array.from({length: generateCount}, () =>
          fetch(`${API_BASE}/generate`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          }).then(async r => {
            const data = await r.json();
            if (!r.ok) throw new Error(data?.detail || data?.error || `HTTP ${r.status}`);
            // bungkus hasil jadi {title, content}
            const content = data.result?.trim() || '';
            const firstLine = content.split('\n').find(Boolean) || 'Variasi';
            const title = `Variasi • ${firstLine.replace(/[#*_~`]+/g,'').slice(0,60)}`;
            return { title, content, imageData: imageForRendering || '' };
          })
        );

        const results = await Promise.all(calls);
        renderResults(results);

      } catch (err) {
        console.error(err);
        showError('Terjadi masalah saat menghubungi AI. Silakan coba lagi. Detail: ' + err.message);
      } finally {
        stopLoading();
      }
    });

    // ====== Delegasi tombol aksi (copy / export) ======
    const outputSectionEl = document.getElementById('outputSection');
    outputSectionEl.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const idx = btn.dataset.index;
      const contentEl = document.getElementById(`content-${idx}`);
      if (!contentEl) return;

      const contentText = contentEl.innerText;
      const contentTitle = contentEl.previousElementSibling.innerText;

      if (btn.classList.contains('copy-btn')) {
        navigator.clipboard.writeText(contentText).then(() => {
          const span = btn.querySelector('.btn-text');
          if (!span) return;
          const old = span.textContent;
          span.textContent = 'Tersalin!';
          btn.classList.add('bg-green-700/50');
          setTimeout(()=>{ span.textContent = old; btn.classList.remove('bg-green-700/50'); }, 1600);
        });
      }

      if (btn.classList.contains('export-word-btn')) {
        const html = `<h1>${contentTitle}</h1><p>${contentText.replace(/\n/g,'<br>')}</p>`;
        const doc = htmlDoc.create({ title: 'Skrip Konten Afiliasi', content: html });
        htmlDoc.download(doc, `skrip-${Number(idx)+1}.docx`);
      }

      if (btn.classList.contains('export-pdf-btn')) {
        const doc = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });
        doc.setTextColor(40);
        doc.setFontSize(16);
        const titleLines = doc.splitTextToSize(contentTitle, 180);
        doc.text(titleLines, 15, 20);
        doc.setFontSize(12);
        const bodyLines = doc.splitTextToSize(contentText, 180);
        doc.text(bodyLines, 15, 20 + (titleLines.length * 7) + 5);
        doc.save(`skrip-konten-afiliasi-${Number(idx)+1}.pdf`);
      }
    });
  </script>
</body>
</html>
