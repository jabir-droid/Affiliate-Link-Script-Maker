<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Affiliate Link Script Maker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-doc-js@1.1.0/dist/html-doc.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
    .card { transition: all 0.3s ease-in-out; border: 1px solid rgba(255, 255, 255, 0.1); }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: all 0.2s; }
    .btn-primary { background-color: #4f46e5; color: white; }
    .btn-primary:hover { background-color: #4338ca; box-shadow: 0 4px 14px 0 rgba(79,70,229,0.39); }
    #loader { border: 4px solid #4a5568; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
  </style>
</head>

<body class="bg-slate-900 text-gray-200">
  <div class="container mx-auto p-4 md:p-8 max-w-4xl relative">
    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-sky-400 to-indigo-400 bg-clip-text text-transparent">
        Affiliate Link Script Maker
      </h1>
      <p class="mt-2 text-lg text-gray-300">
        Generator skrip affiliasi tercepat! Tempel link produk, salin skripnya, dan pasang di web atau media sosial Anda tanpa ribet.
      </p>
    </header>

    <!-- Input Card -->
    <div class="card p-6 md:p-8 mb-8 bg-slate-800/50 backdrop-blur-xl border-slate-700">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="md:col-span-2">
          <label for="productUrl" class="block text-sm font-medium text-gray-300 mb-1">Link Produk (Wajib)</label>
          <input type="url" id="productUrl" placeholder="Tempelkan link produk afiliasi Anda di sini..." class="w-full p-2 border border-slate-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-slate-700 placeholder-gray-400">
        </div>

        <div class="md:col-span-2">
          <label for="productDesc" class="block text-sm font-medium text-gray-300 mb-1">Deskripsi Singkat Produk</label>
          <textarea id="productDesc" rows="2" placeholder="Contoh: Kaos polos bahan adem dan nyaman, cocok buat aktivitas harian." class="w-full p-2 border border-slate-600 rounded-md bg-slate-700 placeholder-gray-400"></textarea>
        </div>

        <div>
          <label for="generateCount" class="block text-sm font-medium text-gray-300 mb-1">Jumlah Hasil</label>
          <input type="number" id="generateCount" value="3" min="1" max="5" class="w-full p-2 border border-slate-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-slate-700">
        </div>

        <div>
          <label for="languageStyle" class="block text-sm font-medium text-gray-300 mb-1">Gaya Bahasa</label>
          <select id="languageStyle" class="w-full p-2 border border-slate-600 rounded-md bg-slate-700">
            <option value="Gen Z">Gen Z (Kekinian)</option>
            <option value="Persuasif">Persuasif</option>
            <option value="Santai">Santai</option>
            <option value="Formal">Formal</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label for="contentLength" class="block text-sm font-medium text-gray-300 mb-1">Panjang Tulisan</label>
          <select id="contentLength" class="w-full p-2 border border-slate-600 rounded-md bg-slate-700">
            <option value="Pendek">Pendek (Caption Sosial Media)</option>
            <option value="Sedang">Sedang (Deskripsi Produk)</option>
            <option value="Panjang">Panjang (Artikel Mini)</option>
          </select>
        </div>
      </div>

      <div class="mt-8 text-center">
        <button id="generateBtn" class="btn btn-primary w-full md:w-auto px-8 py-3 text-lg transform hover:scale-105">
          <i data-lucide="sparkles" class="w-5 h-5"></i>
          <span>Generate Script!</span>
        </button>
      </div>
    </div>

    <!-- Output Section -->
    <div id="outputSection" class="space-y-6"></div>

    <!-- Loader -->
    <div id="loaderContainer" class="hidden justify-center items-center flex-col text-center">
      <div id="loader"></div>
      <p class="mt-4 text-gray-400 font-medium">AI sedang menulis kata-kata terbaikmu... ✍️</p>
    </div>

    <!-- Error -->
    <div id="error-message" class="hidden card bg-red-900/20 border-red-500/30 p-4 text-center mt-6">
      <p class="font-semibold text-red-400">Oops, terjadi kesalahan!</p>
      <p id="error-text" class="text-red-400 text-sm mt-1"></p>
    </div>
  </div>

  <script type="module">
    const { jsPDF } = window.jspdf;
    lucide.createIcons();

    const cache = new Map();
    const generateBtn = document.getElementById("generateBtn");
    const outputSection = document.getElementById("outputSection");
    const loaderContainer = document.getElementById("loaderContainer");
    const errorMessage = document.getElementById("error-message");
    const errorText = document.getElementById("error-text");

    function showError(msg) {
      errorText.textContent = msg;
      errorMessage.classList.remove("hidden");
    }
    function hideError() {
      errorMessage.classList.add("hidden");
    }

    async function generateContent() {
      const productUrl = document.getElementById("productUrl").value.trim();
      const productDesc = document.getElementById("productDesc").value.trim();
      const languageStyle = document.getElementById("languageStyle").value;
      const contentLength = document.getElementById("contentLength").value;
      const generateCount = parseInt(document.getElementById("generateCount").value);

      if (!productUrl) return showError("Masukkan link produk terlebih dahulu!");
      hideError();

      const cacheKey = `${productUrl}-${productDesc}-${languageStyle}-${contentLength}-${generateCount}`;
      if (cache.has(cacheKey)) {
        renderResults(cache.get(cacheKey));
        return;
      }

      outputSection.innerHTML = "";
      loaderContainer.classList.remove("hidden");
      loaderContainer.classList.add("flex");
      generateBtn.disabled = true;

      try {
        const resp = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            linkProduk: productUrl,
            deskripsi: productDesc,
            gaya: languageStyle,
            panjang: contentLength,
            jumlah: generateCount
          })
        });
        if (!resp.ok) throw new Error("Gagal memanggil API.");
        const data = await resp.json();
        if (data.error) throw new Error(data.error);

        cache.set(cacheKey, data.result);
        renderResults(data.result);
      } catch (e) {
        showError("Terjadi kesalahan: " + e.message);
      } finally {
        loaderContainer.classList.add("hidden");
        loaderContainer.classList.remove("flex");
        generateBtn.disabled = false;
      }
    }

    function renderResults(results) {
      outputSection.innerHTML = "";
      if (!results || !results.length) {
        outputSection.innerHTML = "<p class='text-center text-gray-400'>Tidak ada hasil yang bisa ditampilkan.</p>";
        return;
      }

      results.forEach((text, i) => {
        const card = document.createElement("div");
        card.className = "card p-6 bg-slate-800/50 backdrop-blur-xl border-slate-700";
        card.innerHTML = `
          <h3 class="text-lg font-semibold text-indigo-400 mb-2">Variasi ${i+1}</h3>
          <div id="content-${i}" class="text-gray-300 whitespace-pre-wrap">${text}</div>
          <div class="mt-4 flex flex-wrap gap-2 justify-end">
            <button class="btn bg-slate-700 text-gray-200 hover:bg-slate-600 copy-btn" data-index="${i}">
              <i data-lucide="copy" class="w-4 h-4"></i><span>Salin</span>
            </button>
            <button class="btn bg-slate-700 text-gray-200 hover:bg-slate-600 export-pdf-btn" data-index="${i}">
              <i data-lucide="file-text" class="w-4 h-4"></i><span>Export PDF</span>
            </button>
          </div>
        `;
        outputSection.appendChild(card);
      });
      lucide.createIcons();
    }

    outputSection.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const idx = btn.dataset.index;
      const content = document.getElementById(`content-${idx}`).innerText;

      if (btn.classList.contains("copy-btn")) {
        navigator.clipboard.writeText(content);
        btn.classList.add("bg-green-700/50");
        setTimeout(() => btn.classList.remove("bg-green-700/50"), 1500);
      }

      if (btn.classList.contains("export-pdf-btn")) {
        const doc = new jsPDF({ unit: "mm", format: "a4" });
        const lines = doc.splitTextToSize(content, 180);
        doc.text(lines, 15, 20);
        doc.save(`skrip-${idx+1}.pdf`);
      }
    });

    generateBtn.addEventListener("click", generateContent);
  </script>
</body>
</html>
